# ‚úÖ PR-–Ω–∞–±–æ—Ä —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!

## üì¶ –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ `.env.example` - –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `config/settings.py` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏

### 2. Docker –∏ Healthchecks
- ‚úÖ `docker-compose.override.yml` - healthchecks –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –û–±—â–∏–π volume –¥–ª—è storage

### 3. –ú–∏–≥—Ä–∞—Ü–∏–∏ (Alembic)
- ‚úÖ `alembic/env.py` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `alembic.ini` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ environment

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ `scripts/smoke.sh` - smoke-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- ‚úÖ `tests/test_plans_quota.py` - —Ç–µ—Å—Ç—ã –¥–ª—è TTL –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ `tests/test_platega_signature.py` - —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### 5. CI/CD
- ‚úÖ `.github/workflows/ci.yml` - GitHub Actions CI/CD

### 6. Makefile
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã: `migrate`, `upgrade`, `revision`, `smoke`, `fmt`, `lint`

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª

```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker
docker-compose exec bot alembic upgrade head

# –ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –ë–î –∑–∞–ø—É—â–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ)
alembic upgrade head
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã

```bash
# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
make up

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
docker-compose up -d --build
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (smoke-—Ç–µ—Å—Ç)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ smoke-—Ç–µ—Å—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker-compose exec bot bash scripts/smoke.sh

# –ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –≤—Å–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)
bash scripts/smoke.sh
```

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ healthchecks

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose ps

# –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "healthy"
```

---

## üìù –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã Makefile

```bash
# –ú–∏–≥—Ä–∞—Ü–∏–∏
make migrate    # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
make upgrade    # –û–±–Ω–æ–≤–∏—Ç—å –¥–æ head
make revision m="–æ–ø–∏—Å–∞–Ω–∏–µ"  # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
make smoke      # –ó–∞–ø—É—Å—Ç–∏—Ç—å smoke-—Ç–µ—Å—Ç—ã

# –ö–æ–¥
make fmt        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (black)
make lint       # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ (flake8)
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### Smoke-—Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
2. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
3. ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Alembic
4. ‚úÖ –ù–∞–ª–∏—á–∏–µ FFmpeg
5. ‚úÖ –ò–º–ø–æ—Ä—Ç Python –±–∏–±–ª–∏–æ—Ç–µ–∫ (torch, transformers)
6. ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Redis Queue

### Healthchecks:
- **bot**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Python
- **worker**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç FFmpeg –∏ ML –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- **webhook**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç endpoint `/health`
- **postgres**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ë–î
- **redis**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç ping

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
# –ï—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
alembic revision --autogenerate -m "Initial migration"

# –ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—É—Å—Ç—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision -m "Initial migration"
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π:

–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `alembic/versions/`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ:

–î–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
1. Worker —Å ML –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ (torch, transformers, faster-whisper)
2. FFmpeg –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ
3. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ (–º–∏–Ω–∏–º—É–º 4GB RAM)

---

## üìä CI/CD

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º push/PR
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–Ω—Ç–µ—Ä
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

–í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞:
- ‚úÖ –ù–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏:**
   - –í –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –∑–∞–¥–∞—á–∏ –∫–ª–∞–¥—É—Ç—Å—è –≤ Redis/RQ, –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å `Task` –≤ –ë–î
   - –û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

2. **–•–µ–Ω–¥–ª–µ—Ä `/status <task_id>`:**
   - –ß–∏—Ç–∞–π—Ç–µ `Task.status` –∏ `result_path` –∏–∑ –ë–î
   - –ü—Ä–∏ `DONE` –æ—Ç–¥–∞–≤–∞–π—Ç–µ —Ñ–∞–π–ª/—Å—Å—ã–ª–∫—É

3. **Webhook Platega:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å—å `X-Platega-Signature` —á–µ—Ä–µ–∑ HMAC SHA-256
   - –û–±–Ω–æ–≤–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ `subscriptions`

4. **Worker:**
   - –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ Whisper
   - –ö–µ—à –º–æ–¥–µ–ª–µ–π –Ω–∞ `STORAGE_PATH/.models`

5. **GC-–¥–∂–æ–±:**
   - –ß–∏—Å—Ç–∏—Ç–µ `storage` –ø–æ TTL –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã PR-–Ω–∞–±–æ—Ä–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –≤–∞—à—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.
